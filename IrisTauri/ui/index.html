<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iris - NoMercy Anticheat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --neon-red: #ff2d55;
      --neon-orange: #ff6b2c;
      --dark-950: #0a0a0b;
      --dark-900: #18181b;
      --dark-800: #27272a;
      --dark-700: #3f3f46;
      --dark-600: #52525b;
      --dark-500: #71717a;
      --dark-400: #a1a1aa;
    }
    html, body {
      background: transparent;
      height: 100vh;
      overflow: hidden;
    }
    body {
      font-family: 'Outfit', system-ui, sans-serif;
      color: white;
      user-select: none;
    }
    .app-wrapper {
      background: var(--dark-950);
      border-radius: 12px;
      border: 1px solid rgba(255, 45, 85, 0.3);
      height: 100vh;
      overflow: hidden;
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
    }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--dark-900); }
    ::-webkit-scrollbar-thumb { background: var(--dark-600); border-radius: 3px; }
    .title-bar {
      height: 36px;
      background: linear-gradient(to right, rgba(255, 45, 85, 0.1), transparent);
      border-bottom: 1px solid rgba(255, 45, 85, 0.2);
      border-radius: 12px 12px 0 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
    }
    .title-bar-text {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--dark-400);
      font-weight: 500;
    }
    .title-bar-text svg { width: 16px; height: 16px; color: var(--neon-red); }
    .window-controls { display: flex; gap: 8px; position: relative; z-index: 9999; }
    .window-btn {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      transition: transform 0.2s, filter 0.2s;
      position: relative;
      z-index: 9999;
      font-size: 9px;
      line-height: 14px;
      text-align: center;
      color: rgba(0,0,0,0.5);
      padding: 0;
    }
    .window-btn:hover { transform: scale(1.1); filter: brightness(1.2); }
    .btn-minimize { background: #ffbd2e; }
    .btn-close { background: #ff5f57; }
    .container {
      height: calc(100vh - 36px);
      padding: 12px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-y: auto;
    }
    .bg-gradient {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(ellipse at 50% 0%, rgba(255, 45, 85, 0.15) 0%, transparent 60%),
                  radial-gradient(ellipse at 0% 100%, rgba(255, 107, 44, 0.1) 0%, transparent 50%);
    }
    .content {
      position: relative;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }
    .logo-section { text-align: center; margin-bottom: 16px; }
    .logo-container { position: relative; display: inline-block; margin-bottom: 12px; }
    .logo-glow {
      position: absolute;
      inset: -15px;
      background: radial-gradient(circle, rgba(255, 45, 85, 0.4) 0%, transparent 70%);
      filter: blur(15px);
      animation: pulse-glow 3s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { opacity: 0.5; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.1); }
    }
    .logo {
      position: relative;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--neon-red) 0%, var(--neon-orange) 100%);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 30px rgba(255, 45, 85, 0.4);
    }
    .logo img { width: 48px; height: 48px; object-fit: contain; }
    .logo svg { width: 32px; height: 32px; color: white; }
    .app-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 36px;
      letter-spacing: 6px;
      background: linear-gradient(135deg, var(--neon-red) 0%, var(--neon-orange) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .app-subtitle { font-size: 10px; color: var(--dark-400); letter-spacing: 3px; text-transform: uppercase; }
    .card {
      background: rgba(24, 24, 27, 0.8);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 45, 85, 0.2);
      border-radius: 14px;
      padding: 16px;
      width: 100%;
      max-width: 340px;
    }
    #login-view .card { text-align: center; }
    .login-title { font-size: 18px; font-weight: 600; margin-bottom: 6px; }
    .login-description { color: var(--dark-400); font-size: 13px; margin-bottom: 16px; line-height: 1.4; }
    .discord-btn {
      width: 100%;
      padding: 14px 24px;
      background: #5865F2;
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s ease;
    }
    .discord-btn:hover { background: #4752C4; transform: translateY(-2px); box-shadow: 0 8px 24px rgba(88, 101, 242, 0.4); }
    .discord-btn svg { width: 20px; height: 20px; }
    #loading-view, #connected-view { display: none; }
    #loading-view .card { text-align: center; }
    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--dark-700);
      border-top-color: var(--neon-red);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: var(--dark-400); font-size: 14px; }
    .user-section {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255, 45, 85, 0.05);
      border: 1px solid rgba(255, 45, 85, 0.2);
      border-radius: 10px;
      margin-bottom: 12px;
    }
    .avatar-container {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid var(--neon-red);
      box-shadow: 0 0 15px rgba(255, 45, 85, 0.3);
      overflow: hidden;
      background: linear-gradient(135deg, var(--neon-red) 0%, var(--neon-orange) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .user-avatar {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .user-info { flex: 1; }
    .user-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .user-status { font-size: 11px; color: #22c55e; display: flex; align-items: center; gap: 5px; }
    .status-dot {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      animation: pulse-dot 2s ease-in-out infinite;
    }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .protection-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 10px;
      margin-bottom: 16px;
    }
    .protection-badge svg { width: 20px; height: 20px; color: #22c55e; }
    .protection-badge span { font-size: 14px; font-weight: 500; color: #22c55e; }
    .logout-btn {
      width: 100%;
      padding: 10px;
      background: transparent;
      border: 1px solid rgba(255, 45, 85, 0.3);
      border-radius: 8px;
      color: var(--neon-red);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .logout-btn:hover { background: rgba(255, 45, 85, 0.1); border-color: var(--neon-red); }
    /* Trust Score Section */
    .trust-score-section {
      margin-bottom: 12px;
      text-align: center;
    }
    .trust-score-value {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 48px;
      line-height: 1;
      margin-bottom: 4px;
    }
    .trust-score-value.high { color: #22c55e; }
    .trust-score-value.medium { color: #f59e0b; }
    .trust-score-value.low { color: #ef4444; }
    .trust-score-label {
      font-size: 11px;
      color: var(--dark-400);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    /* Module loading animation */
    .module-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px;
      background: rgba(255, 45, 85, 0.05);
      border: 1px solid rgba(255, 45, 85, 0.2);
      border-radius: 8px;
      margin-bottom: 12px;
      color: var(--dark-400);
      font-size: 12px;
    }
    .module-loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--dark-700);
      border-top-color: var(--neon-red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .error-message {
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 10px;
      color: #ef4444;
      font-size: 14px;
      text-align: center;
      margin-bottom: 16px;
      display: none;
    }
    .footer { margin-top: auto; padding-top: 8px; text-align: center; }
    .footer-text { font-size: 10px; color: var(--dark-600); }
    .footer-link { color: var(--neon-red); text-decoration: none; cursor: pointer; }
    .footer-link:hover { text-decoration: underline; }
    .version { font-size: 9px; color: var(--dark-600); margin-top: 4px; }
    .fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .slide-up { animation: slideUp 0.5s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Update Dialog Styles */
    .update-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .update-overlay.visible { display: flex; }
    .update-dialog {
      background: var(--dark-900);
      border: 1px solid rgba(255, 45, 85, 0.3);
      border-radius: 16px;
      padding: 24px;
      max-width: 320px;
      text-align: center;
      animation: slideUp 0.3s ease-out;
    }
    .update-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, var(--neon-red), var(--neon-orange));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .update-icon svg { width: 28px; height: 28px; color: white; }
    .update-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .update-version { 
      font-family: 'Bebas Neue', sans-serif;
      font-size: 24px;
      color: var(--neon-red);
      margin-bottom: 12px;
    }
    .update-changelog {
      font-size: 13px;
      color: var(--dark-400);
      text-align: left;
      background: var(--dark-950);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      max-height: 120px;
      overflow-y: auto;
      white-space: pre-line;
    }
    .update-btn {
      width: 100%;
      padding: 14px 24px;
      background: linear-gradient(135deg, var(--neon-red), var(--neon-orange));
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }
    .update-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(255, 45, 85, 0.4); }
    .update-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
    .update-btn svg { width: 20px; height: 20px; }
    .update-later {
      background: transparent;
      border: 1px solid var(--dark-600);
      color: var(--dark-400);
    }
    .update-later:hover { border-color: var(--dark-400); color: white; box-shadow: none; }
    .update-progress {
      width: 100%;
      height: 6px;
      background: var(--dark-800);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .update-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--neon-red), var(--neon-orange));
      border-radius: 3px;
      transition: width 0.3s ease;
      animation: progress-pulse 1.5s ease-in-out infinite;
    }
    @keyframes progress-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .update-status { font-size: 13px; color: var(--dark-400); }
  </style>
</head>
<body>
  <div class="app-wrapper">
  <div class="title-bar" data-tauri-drag-region>
    <div class="title-bar-text">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
      <span>IRIS ANTICHEAT</span>
    </div>
    <div class="window-controls" id="window-controls">
      <button class="window-btn btn-minimize" id="btn-minimize" title="Réduire">&#8211;</button>
      <button class="window-btn btn-close" id="btn-close" title="Fermer">&#10005;</button>
    </div>
  </div>

  <div class="container">
    <div class="bg-gradient"></div>
    <div class="content">
      <div class="logo-section fade-in">
        <div class="logo-container">
          <div class="logo-glow"></div>
          <div class="logo">
            <img id="logo-img" src="https://nomercy.ggsecure.io/logo.png" alt="NoMercy">
            <svg id="logo-fallback" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
              <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
            </svg>
          </div>
        </div>
        <h1 class="app-title">IRIS</h1>
        <p class="app-subtitle">NoMercy Security</p>
      </div>

      <div id="login-view" class="slide-up">
        <div class="card">
          <h2 class="login-title">Connexion requise</h2>
          <p class="login-description">
            Connectez-vous avec votre compte Discord lié à NoMercy pour activer la protection anticheat.
          </p>
          <div id="login-error" class="error-message"></div>
          <button class="discord-btn" id="discord-btn">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M20.317 4.37a19.79 19.79 0 00-4.885-1.515.074.074 0 00-.079.037 13.13 13.13 0 00-.608 1.25 18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037 19.736 19.736 0 00-4.884 1.515.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028 14.09 14.09 0 001.226-1.994.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128c.122-.093.244-.19.361-.289a.074.074 0 01.078-.012c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 01.078.01c.118.098.24.195.361.288a.077.077 0 01-.006.128 12.299 12.299 0 01-1.873.892.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.839 19.839 0 006.002-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
            </svg>
            <span>Se connecter avec Discord</span>
          </button>
        </div>
      </div>

      <div id="loading-view">
        <div class="card">
          <div class="spinner"></div>
          <p class="loading-text" id="loading-message">Vérification de la session...</p>
        </div>
      </div>

      <div id="connected-view">
        <div class="card">
          <div class="user-section">
            <div id="avatar-container" class="avatar-container">
              <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
            </div>
            <div class="user-info">
              <div id="user-name" class="user-name">Username</div>
              <div class="user-status">
                <div class="status-dot"></div>
                <span>Connecté</span>
              </div>
            </div>
          </div>
          
          <!-- Trust Score -->
          <div class="trust-score-section">
            <div id="trust-score" class="trust-score-value high">100%</div>
            <div class="trust-score-label" id="trust-score-label">Score de confiance</div>
          </div>
          

          
          <button class="logout-btn" id="logout-btn">Déconnexion</button>
        </div>
      </div>

      <div class="footer">
        <p class="footer-text">
          En utilisant Iris, vous acceptez les 
          <a class="footer-link" id="terms-link">conditions d'utilisation</a>
        </p>
        <p class="version" id="app-version">v1.0.0</p>
      </div>
    </div>
  </div>
  </div><!-- end app-wrapper -->

  <!-- Update Dialog -->
  <div class="update-overlay" id="update-overlay">
    <div class="update-dialog">
      <div class="update-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
      </div>
      <h3 class="update-title">Mise à jour disponible</h3>
      <div class="update-version" id="update-version">v2.0.0</div>
      <div class="update-changelog" id="update-changelog">
        Chargement des notes de version...
      </div>
      
      <!-- Normal state -->
      <div id="update-actions">
        <button class="update-btn" id="update-install-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          <span>Mettre à jour</span>
        </button>
        <button class="update-btn update-later" id="update-later-btn">
          Plus tard
        </button>
      </div>
      
      <!-- Installing state -->
      <div id="update-installing" style="display: none;">
        <div class="update-progress">
          <div class="update-progress-bar" id="update-progress-bar" style="width: 0%"></div>
        </div>
        <p class="update-status" id="update-status">Téléchargement en cours...</p>
      </div>
    </div>
  </div>

  <script>
    // Tauri v2 API - different structure than v1
    const invoke = window.__TAURI__?.core?.invoke;

    // Detect dev mode: in Tauri dev, we're on localhost:1420
    // In production Tauri build, we're on tauri.localhost
    const IS_DEV = window.location.hostname === 'localhost' && window.location.port !== '';
    const BASE_URL = IS_DEV ? 'http://localhost:5173' : 'https://nomercy.ggsecure.io';
    const TERMS_URL = `${BASE_URL}/iris-terms`;
    
    console.log('[Iris] Mode:', IS_DEV ? 'DEV' : 'PROD', '| Host:', window.location.hostname, '| Port:', window.location.port, '| Terms URL:', TERMS_URL);

    if (!invoke) {
      console.error('[Iris] Tauri API not available. Make sure withGlobalTauri is enabled.');
      console.log('[Iris] Available TAURI:', window.__TAURI__);
    }
    const loginView = document.getElementById('login-view');
    const loadingView = document.getElementById('loading-view');
    const connectedView = document.getElementById('connected-view');
    const loginError = document.getElementById('login-error');
    const loadingMessage = document.getElementById('loading-message');

    // --- Event listeners (no inline handlers for CSP compatibility) ---
    const windowControls = document.getElementById('window-controls');
    if (windowControls) {
      windowControls.addEventListener('mousedown', function(e) { e.stopPropagation(); });
    }
    document.getElementById('btn-minimize').addEventListener('click', function(e) {
      e.stopPropagation();
      minimizeWindow();
    });
    document.getElementById('btn-close').addEventListener('click', function(e) {
      e.stopPropagation();
      closeWindow();
    });
    document.getElementById('discord-btn').addEventListener('click', function() {
      startAuth();
    });
    document.getElementById('logout-btn').addEventListener('click', function() {
      logout();
    });
    document.getElementById('terms-link').addEventListener('click', function() {
      openExternal(TERMS_URL);
    });

    // Logo fallback
    var logoImg = document.getElementById('logo-img');
    var logoFallback = document.getElementById('logo-fallback');
    if (logoImg) {
      logoImg.addEventListener('error', function() {
        logoImg.style.display = 'none';
        logoFallback.style.display = 'block';
      });
    }

    function showView(view) {
      loginView.style.display = 'none';
      loadingView.style.display = 'none';
      connectedView.style.display = 'none';
      view.style.display = 'block';
    }

    function showError(message, isTPM = false) {
      if (isTPM) {
        loginError.innerHTML = `
          <div style="text-align: left;">
            <strong style="color: #ef4444; display: block; margin-bottom: 8px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 6px;">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
              </svg>
              TPM Requis
            </strong>
            <span style="white-space: pre-line;">${message}</span>
          </div>
        `;
      } else {
        loginError.textContent = message;
      }
      loginError.style.display = 'block';
      showView(loginView);
    }

    async function startAuth() {
      console.log('[UI] Discord button clicked');
      loginError.style.display = 'none';
      loadingMessage.textContent = 'Ouverture de Discord...';
      showView(loadingView);

      try {
        console.log('[UI] Invoking start_discord_auth...');
        const result = await invoke('start_discord_auth');
        console.log('[UI] Auth result:', result);
        if (!result.success && result.message) {
          showError(result.message, result.message.includes('TPM'));
        } else {
          loadingMessage.textContent = 'En attente de votre autorisation...';
        }
      } catch (e) {
        console.error('[UI] Auth error:', e);
        showError(e.toString());
      }
    }

    async function logout() {
      try {
        await invoke('logout');
        showView(loginView);
      } catch (e) {
        console.error('Logout error:', e);
      }
    }

    function updateConnectedView(user) {
      const avatarContainer = document.getElementById('avatar-container');
      
      console.log('[UI] User avatar URL:', user.avatarUrl);
      
      // Fallback SVG for Iris logo
      const irisFallback = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`;
      
      // Show avatar if available
      if (user.avatarUrl) {
        const img = document.createElement('img');
        img.className = 'user-avatar';
        img.alt = 'Avatar';
        
        img.onload = function() {
          console.log('[UI] Avatar loaded successfully');
          avatarContainer.innerHTML = '';
          avatarContainer.appendChild(img);
        };
        
        img.onerror = function() {
          console.log('[UI] Avatar failed to load, using fallback');
          avatarContainer.innerHTML = irisFallback;
        };
        
        // Start loading (use crossorigin for external URLs)
        if (user.avatarUrl.includes('cdn.discordapp.com')) {
          img.crossOrigin = 'anonymous';
        }
        img.src = user.avatarUrl;
        
        // Set timeout fallback in case image hangs
        setTimeout(() => {
          if (!img.complete || img.naturalWidth === 0) {
            console.log('[UI] Avatar load timeout, using fallback');
            avatarContainer.innerHTML = irisFallback;
          }
        }, 5000);
      } else {
        // No avatar - show Iris logo
        avatarContainer.innerHTML = irisFallback;
      }
      
      document.getElementById('user-name').textContent = user.username;
      showView(connectedView);
      
      // Reset score to 0% and show loading state
      const scoreEl = document.getElementById('trust-score');
      const scoreLabelEl = document.getElementById('trust-score-label');
      
      scoreEl.textContent = '-';
      scoreEl.className = 'trust-score-value low';
      scoreLabelEl.textContent = 'Initialisation...';
      

      
      // Fetch and display security status with animation
      fetchSecurityStatus();
      
      invoke('start_heartbeat').catch(console.error);
    }

    async function fetchSecurityStatus() {
      try {
        const security = await invoke('get_security_status');
        animateSecurityDisplay(security);
      } catch (e) {
        console.error('[UI] Failed to get security status:', e);
      }
    }

    async function animateSecurityDisplay(security) {
      // Update label
      document.getElementById('trust-score-label').textContent = 'Score de confiance';
      
      // Debug: Log raw security data
      console.log('[Iris UI] Raw security data:', JSON.stringify(security, null, 2));
      
      // Define modules with their values (internal only for score calculation)
      // Must match the admin panel calculation (9 modules total)
      const modules = [
        { name: 'TPM', enabled: security.tpm?.enabled },
        { name: 'Secure Boot', enabled: security.secureBoot || security.secure_boot?.enabled },
        { name: 'Virtualization', enabled: security.virtualization || security.virtualization?.enabled },
        { name: 'IOMMU', enabled: security.iommu || security.virtualization?.iommu },
        { name: 'DMA Protection', enabled: security.kernelDmaProtection || security.virtualization?.kernel_dma_protection },
        { name: 'HVCI', enabled: security.hvci || security.vbs?.hvci_enabled },
        { name: 'VBS', enabled: security.vbs || security.vbs?.enabled },
        { name: 'Defender', enabled: security.defender || security.defender?.enabled },
        { name: 'Defender RT', enabled: security.defenderRealtime || security.defender?.real_time_protection }
      ];
      
      // Debug: Log each module's status
      console.log('[Iris UI] Security modules:', modules.map(m => `${m.name}: ${m.enabled}`));
      
      const totalCount = modules.length;
      const enabledCount = modules.filter(m => m.enabled).length;
      const finalScore = Math.round((enabledCount / totalCount) * 100);
      
      // Debug: Log final calculation
      console.log('[Iris UI] Trust score:', { enabled: enabledCount, total: totalCount, score: finalScore });
      
      // Animate score from 0 to final value
      const scoreEl = document.getElementById('trust-score');
      animateScore(0, finalScore, scoreEl);
    }
    
    function animateScore(from, to, element) {
      const duration = 200;
      const start = performance.now();
      
      function update(time) {
        const elapsed = time - start;
        const progress = Math.min(elapsed / duration, 1);
        
        // Ease out
        const easeProgress = 1 - Math.pow(1 - progress, 3);
        const current = Math.round(from + (to - from) * easeProgress);
        
        element.textContent = current + '%';
        element.className = 'trust-score-value ' + (current >= 75 ? 'high' : current >= 50 ? 'medium' : 'low');
        
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      
      requestAnimationFrame(update);
    }

    async function minimizeWindow() {
      console.log('[UI] Minimize clicked');
      try {
        await invoke('window_minimize');
      } catch (e) {
        console.error('[UI] Minimize error:', e);
      }
    }

    async function closeWindow() {
      console.log('[UI] Close clicked');
      try {
        await invoke('window_close');
      } catch (e) {
        console.error('[UI] Close error:', e);
      }
    }

    async function openExternal(url) {
      await invoke('open_external', { url });
    }

    async function init() {
      showView(loadingView);
      loadingMessage.textContent = 'Vérification de la session...';

      try {
        const session = await invoke('verify_session');
        
        if (session.success && session.user) {
          updateConnectedView(session.user);
        } else {
          if (session.reason === 'tpm_disabled') {
            showError(session.message, true);
          } else {
            showView(loginView);
          }
        }
      } catch (e) {
        console.error('Session verification error:', e);
        showView(loginView);
      }
    }

    // Listen for auth events from Tauri (v2 API)
    const listen = window.__TAURI__?.event?.listen;
    if (listen) {
      listen('auth-success', (event) => {
        updateConnectedView(event.payload.user);
      });

      listen('auth-error', (event) => {
        showError(event.payload.message, event.payload.type === 'tpm_disabled');
      });

      listen('cheat-detected', (event) => {
        console.warn('Cheat detected:', event.payload);
        // Could show a warning to the user
      });

      // Listen for update available event
      listen('update-available', (event) => {
        console.log('[UI] Update available:', event.payload);
        showUpdateDialog(event.payload);
      });
    }

    // --- Update Dialog Functions ---
    const updateOverlay = document.getElementById('update-overlay');
    const updateVersion = document.getElementById('update-version');
    const updateChangelog = document.getElementById('update-changelog');
    const updateActions = document.getElementById('update-actions');
    const updateInstalling = document.getElementById('update-installing');
    const updateProgressBar = document.getElementById('update-progress-bar');
    const updateStatus = document.getElementById('update-status');
    let pendingUpdate = null;

    function showUpdateDialog(updateInfo) {
      pendingUpdate = updateInfo;
      updateVersion.textContent = 'v' + (updateInfo.version || '?');
      updateChangelog.textContent = updateInfo.changelog || 'Améliorations et corrections de bugs.';
      updateActions.style.display = 'block';
      updateInstalling.style.display = 'none';
      
      // All updates are mandatory - hide the "Later" button
      const laterBtn = document.getElementById('update-later-btn');
      laterBtn.style.display = 'none';
      
      updateOverlay.classList.add('visible');
    }

    function hideUpdateDialog() {
      // Cannot hide for mandatory updates - do nothing
      // updateOverlay.classList.remove('visible');
      // pendingUpdate = null;
    }

    async function installUpdate() {
      if (!pendingUpdate) return;
      
      console.log('[UI] Starting update installation...');
      
      // Switch to installing state
      updateActions.style.display = 'none';
      updateInstalling.style.display = 'block';
      updateStatus.textContent = 'Téléchargement en cours...';
      
      // Animate progress bar (indeterminate)
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress = Math.min(progress + Math.random() * 15, 90);
        updateProgressBar.style.width = progress + '%';
      }, 500);
      
      try {
        updateStatus.textContent = 'Installation...';
        await invoke('install_update');
        
        // If we get here, update was successful and app will restart
        clearInterval(progressInterval);
        updateProgressBar.style.width = '100%';
        updateStatus.textContent = 'Redémarrage...';
      } catch (e) {
        console.error('[UI] Update error:', e);
        clearInterval(progressInterval);
        updateStatus.textContent = 'Erreur: ' + e;
        
        // Show retry button after 3 seconds
        setTimeout(() => {
          updateActions.style.display = 'block';
          updateInstalling.style.display = 'none';
        }, 3000);
      }
    }

    // Update dialog event listeners
    document.getElementById('update-install-btn').addEventListener('click', installUpdate);
    document.getElementById('update-later-btn').addEventListener('click', hideUpdateDialog);

    // Check for updates manually (can be called from connected view)
    async function checkForUpdates() {
      try {
        const updateInfo = await invoke('check_for_updates');
        if (updateInfo.available) {
          showUpdateDialog(updateInfo);
        }
      } catch (e) {
        console.error('[UI] Update check error:', e);
      }
    }

    // Fetch and display current version
    async function displayVersion() {
      try {
        const version = await invoke('get_version');
        document.getElementById('app-version').textContent = 'v' + version;
      } catch (e) {
        console.log('[UI] Could not get version:', e);
      }
    }

    displayVersion();
    init();
  </script>
</body>
</html>
